{
  auto_https off
}

:80 {
  # API -> /api e /api/...
  # handle_path rimuove il prefisso /api prima di inoltrare al backend
  # Quindi /api/hubs/kds diventa /hubs/kds nel backend
  handle_path /api* {
    reverse_proxy backend:8080 {
      # Abilita WebSocket upgrade per SignalR
      header_up Connection {>Connection}
      header_up Upgrade {>Upgrade}
    }
  }

  # WEB -> /web e /web/... (SPA)
  # Forza trailing slash su /web per evitare path vuoto verso upstream
  handle /web {
    redir /web/ 308
  }
  handle /web* {
    # Rimuove il prefisso /web e inoltra il path risultante
    uri strip_prefix /web
    reverse_proxy web:80
  }

  # /health del proxy (per healthcheck di caddy nel compose)
  handle_path /health {
    reverse_proxy backend:8080
  }

  # Root "/" -> redirect a /web
  handle / {
    redir /web 302
  }

  log {
    output stdout
    format console
  }
}
